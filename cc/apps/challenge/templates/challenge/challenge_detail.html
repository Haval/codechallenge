{% extends 'base.html' %}

{% block contents %}

	<header class="col-md-6 col-lg-6">
		<h1>
			{{ challenge.name }}
			{% if is_owner %}
			<a href="{% url 'challenge:maintain' challenge.id %}"><i class="fa fa-pencil"></i></a>
			{% endif %}
			<small>
				{{ challenge.duration }} day{{challenge.duration|pluralize}}
			</small>
		</h1>
		{% if user.is_authenticated %}
		<div class="row">
			<ul class="nav nav-pills nav-stacked pull-left">
			{% if participant %}
				<li><a title="Leave this challenge" href="{% url 'challenge:leave' challenge.id %}"><i class="fa fa-minus-square"></i> Leave challenge</a></li>
			{% else %}
				<li><a title="Join this challenge" href="{% url 'challenge:join' challenge.id %}"><i class="fa fa-plus-square"></i> Join challenge</a></li>
			{% endif %}
			</ul>
		</div>
	{% endif %}

	{% include 'challenge/rules.html' with challenge=challenge %}

	</header>

	{% include 'challenge/stats.html' with challenge=challenge participant=participant %}

	{% include 'challenge/entries.html' with challenge=challenge participant=participant %}

	{% include 'challenge/participants.html' with challenge=challenge %}

	{% include 'challenge/challenge_comments.html' with challenge=challenge can_comment=can_comment %}

{% endblock %}

{% block extrascripts %}

<script type="text/javascript">
	var KEY_ENTER = 13,
		KEY_ESCAPE = 27;

	function MakeEditable(span) {
		var $span = $(span);

		$span.hide();
		$span.siblings('[data-input]')
			.show()
			.keydown(function(e) { UpdateChallenge(e, $span, $(this)); })
			.focus();
	}

	function UpdateChallenge(e, $span, $input) {
		if (e.which == KEY_ENTER) {

			var rel = $input.attr('rel'),
				val = $input.val();

			var postData = {
				csrfmiddlewaretoken: '{{ csrf_token }}',
				name: rel,
				value: val
			};

			$.post('/challenge/{{ challenge.id }}/update', postData, function(data) {
				$('[data-challenge-' + rel + ']').text(val).show();
				$input.hide();
			});
		}
		else if (e.which == KEY_ESCAPE) {
			$span.show();
			$input.hide();
		}
	}

	function MakeRuleEditable(a, rule_id) {
		var $span = $(a).parents('[data-rule-container]').find('[data-span]');

		$span.hide();
		$span.siblings('[data-input]')
			.show()
			.keydown(function(e) { UpdateRule(e, $span, $(this), rule_id); })
			.focus();
	}

	function AddRule() {
		// $('[data-rule-list]').append('<li>Test</li>');
		$.get('/challenge/add_rule_template/1', function(data) {
			$('[data-rule-list]').append(data);
			// $totalForms.val(++ruleCount);
		});
	}

	function DeleteRule(a, rule_id) {
		var postData = { csrfmiddlewaretoken: '{{ csrf_token }}' };

		$.post('/challenge/' + rule_id + '/delete_rule', postData, function(data) {
			if (data == 'yay')
				$(a).parents('[data-rule-container]').remove();
		});
	}

	function UpdateRule(e, $span, $input, rule_id) {
		if (e.which == KEY_ENTER) {

			var rel = $input.attr('rel'),
				val = $input.val();

			var postData = {
				csrfmiddlewaretoken: '{{ csrf_token }}',
				name: rel,
				value: val
			};

			$.post('/challenge/' + rule_id + '/update_rule', postData, function(data) {
				$span.text(val).show();
				$input.hide();
			});
		}
		else if (e.which == KEY_ESCAPE) {
			$span.show();
			$input.hide();
		}
	}

	$('[title]').tooltip({container: 'body', delay:{show:1000,hide:0}});
</script>

{% endblock %}
